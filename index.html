<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculette de Crédit Complexe</title>
  <!-- Chargement du CSS de Chart.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdfdfd;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
      color: #0066cc;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      display: block;
      margin: 20px auto;
      padding: 12px 20px;
      background-color: #0066cc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover {
      background-color: #0055aa;
    }
    .chart-container {
      width: 100%;
      height: 400px;
      margin-top: 30px;
    }
    #resultats {
      text-align: center;
      margin-top: 20px;
      font-size: 1.1em;
    }
    /* Styles pour le tableau d'amortissement */
    #tableContainer {
      margin-top: 30px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ddd;
    }
    th {
      background-color: #0066cc;
      color: #fff;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculette de Crédit Immobilier</h1>
    <!-- Formulaire de saisie -->
    <label for="montant">Montant du prêt (€)</label>
    <input type="number" id="montant" value="200000" min="1000">

    <label for="duree">Durée (années)</label>
    <input type="number" id="duree" value="20" min="1">

    <label for="taux">Taux d'intérêt (%)</label>
    <input type="number" id="taux" value="3.5" step="0.1" min="0">

    <label for="assurance">Taux d'assurance (%)</label>
    <input type="number" id="assurance" value="0.5" step="0.01" min="0">

    <button id="calculer">Calculer</button>
    
    <!-- Affichage synthétique des résultats -->
    <div id="resultats"></div>
    
    <!-- Graphique d'amortissement -->
    <div class="chart-container">
      <canvas id="amortizationChart"></canvas>
    </div>
    
    <!-- Tableau d'amortissement -->
    <div id="tableContainer">
      <h2>Tableau d'Amortissement</h2>
      <div id="amortizationTable"></div>
    </div>
  </div>

  <!-- Insertion de Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
  <script>
    document.getElementById('calculer').addEventListener('click', function() {
      const montant = parseFloat(document.getElementById('montant').value);
      let duree = parseInt(document.getElementById('duree').value);
      let taux = parseFloat(document.getElementById('taux').value);
      let assurance = parseFloat(document.getElementById('assurance').value);

      // Appliquer des limites aux entrées (facultatif)
      duree = Math.min(duree, 30);
      taux = Math.min(taux, 20);
      assurance = Math.min(assurance, 2);

      if (isNaN(montant) || isNaN(duree) || isNaN(taux) || montant <= 0 || duree <= 0 || taux < 0) {
        alert("Veuillez entrer des valeurs valides.");
        return;
      }

      const nbMois = duree * 12;
      const tauxMensuel = taux / 100 / 12;
      const assuranceMensuelle = montant * (assurance / 100) / 12;
      
      // Calcul de la mensualité hors assurance (gestion du cas taux nul)
      let mensualite;
      if (tauxMensuel === 0) {
        mensualite = montant / nbMois;
      } else {
        mensualite = (montant * tauxMensuel * Math.pow(1 + tauxMensuel, nbMois)) / (Math.pow(1 + tauxMensuel, nbMois) - 1);
      }
      const mensualiteTotale = mensualite + assuranceMensuelle;
      
      // Affichage synthétique
      document.getElementById('resultats').innerHTML = 
        `<p>Mensualité hors assurance : ${mensualite.toFixed(2)} €</p>
         <p>Mensualité avec assurance : ${mensualiteTotale.toFixed(2)} €</p>`;

      // Préparation des données pour le graphique
      let capitalRestantGraph = montant;
      let dataGraph = [];
      for (let i = 0; i < nbMois; i++) {
        let interets = capitalRestantGraph * tauxMensuel;
        let amortissement = mensualite - interets;
        capitalRestantGraph -= amortissement;
        dataGraph.push(capitalRestantGraph > 0 ? capitalRestantGraph : 0);
      }

      // Création/détruction du graphique
      const ctx = document.getElementById('amortizationChart').getContext('2d');
      if (window.amortizationChart) {
        window.amortizationChart.destroy();
      }
      window.amortizationChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: nbMois }, (_, i) => i + 1),
          datasets: [{
            label: 'Capital Restant Dû (€)',
            data: dataGraph,
            borderColor: '#0066cc',
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Mois' } },
            y: { title: { display: true, text: 'Capital Restant (€)' } }
          }
        }
      });

      // Génération du tableau d'amortissement
      let tableHTML = '<table>';
      tableHTML += '<thead><tr><th>Mois</th><th>Mensualité</th><th>Intérêts</th><th>Amortissement</th><th>Capital Restant</th></tr></thead><tbody>';
      let capitalRestant = montant;
      for (let i = 0; i < nbMois; i++) {
        let interets = capitalRestant * tauxMensuel;
        let amortissement = mensualite - interets;
        // Ajuster la dernière ligne si nécessaire
        if (capitalRestant < mensualite) {
          amortissement = capitalRestant;
          mensualite = amortissement + interets;
        }
        capitalRestant -= amortissement;
        tableHTML += `<tr>
                        <td>${i + 1}</td>
                        <td>${mensualite.toFixed(2)}</td>
                        <td>${interets.toFixed(2)}</td>
                        <td>${amortissement.toFixed(2)}</td>
                        <td>${capitalRestant > 0 ? capitalRestant.toFixed(2) : '0.00'}</td>
                      </tr>`;
      }
      tableHTML += '</tbody></table>';
      document.getElementById('amortizationTable').innerHTML = tableHTML;
    });
  </script>
</body>
</html>
